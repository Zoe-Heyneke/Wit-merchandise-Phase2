<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Women in Tech</title>
  <link rel="stylesheet" href="style.css"> 
  <script src="https://kit.fontawesome.com/a2e0e6ad5f.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <header>
    <a href="index.html">
        <img src="images/Logo_South Africa white.png" alt="Women in Tech" width="150" height="150">
    </a>
    <nav>
      <a href="index.html">Home</a>
      <a href="index.html#how-it-works">How it Works</a>
      <a href="products.html">Products</a>
      <a href="inspired.html">Get Inspired</a>
      <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a> 
      <a href="checkout.html" class="underlined">Checkout</a>
      <a href="profile.html"><i class="fa-solid fa-user"></i></a>
    </nav>
  </header>

  <main class="checkout-container">
    <!-- Order Summary -->
    <section class="order-summary">
      <h3>Order Summary</h3>
      <p><strong>Total Amount:</strong> R<span id="orderTotal">0.00</span></p>
      <a href= "cart.html" class="checkout-btn">View More...</a>
    </section>

    <!-- Shipping Section -->
    <div class="shipping-section">
      <h3>Shipping Address</h3>

      <label style="display:flex;align-items:center;gap:.5rem;margin-top:.5rem;">
        <input type="checkbox" id="useProfileAddress" checked>
        <span>Use profile address</span>
      </label>
      <div id="profileAddrPreview" class="addr-preview small-note">Loading your profile address‚Ä¶</div>
      <div id="profileAddrMissing" class="addr-preview addr-empty hidden">
        No address found in your profile. Untick ‚ÄúUse profile address‚Äù to enter a shipping address.
      </div>

      <!-- Alternate shipping form -->
      <div id="shippingForm" class="shipping-form">
        <div class="shipping-row">
          <input id="shipName" class="full" type="text" placeholder="Full Name">
          <input id="shipPhone" type="tel" placeholder="Phone Number">
          <input id="shipEmail" type="email" placeholder="Email">
          <input id="shipStreet" class="full" type="text" placeholder="Street">
          <select id="shipBuilding" >
            <option value="">Building Type</option>
            <option>Apartment</option>
            <option>House</option>
            <option>Complex</option>
            <option>Townhouse</option>
            <option>Office</option>
            <option>Other</option>
          </select>
          <input id="shipNeighborhood" type="text" placeholder="Neighborhood">
          <input id="shipCity" type="text" placeholder="City">
          <input id="shipPostal" type="text" placeholder="Postal Code">
        </div>
      </div>
    </div>

    <!-- Payment Options -->
    <section class="payment-options">
      <h3>Select Payment Method</h3>
      <select id="paymentMethod" onchange="showPaymentDetails()">
        <option value="" disabled selected>Choose a method</option>
        <option value="eft">EFT (Bank Transfer)</option>
        <option value="payfast">PayFast (Online Payment)</option>
      </select>

      <!-- EFT Box -->
      <div id="eft" class="payment-box" style="display:none;">
        <h4>EFT Payment</h4>
        <div id="paymentDetails">
        <h4>Bank Transfer Details</h4>
        <p><strong>Bank:</strong> First National Bank (FNB)</p>
        <p><strong>Account Name:</strong> South Africa Chapter Women in Tech NPC</p>
        <p><strong>Account Number:</strong> 62869256208</p>
        <p><strong>Branch Code:</strong> 201709</p>
        <p>Please send proof of payment to: <a href="mailto:melissa@women-in-tech.org">melissa@women-in-tech.org</a></p>
      
    </div>
      </div>

      <!-- PayFast Box -->
      <div id="payfast" class="payment-box" style="display:none;">
        <h4>PayFast Secure Payment</h4>
        <p>You‚Äôll be redirected to PayFast to complete your payment securely.</p>
      </div>
    </section>

    <!-- Confirm Button -->
    <button onclick="proceedPayment()" class="checkout-btn">
      Confirm & Pay
    </button>

    <button id="speechBtn" onclick="readAllText()" class="read-btn">
      üîä Read All Text
    </button>
  </main>

  <footer>
    <div class="footer-container">
      <div class="footer-left">
        <a href="index.html">
          <img src="images/Logo_South Africa white.png" alt="Women in Tech" width="150" height="150">
        </a>
        <p>Empowering women in technology with confidence and excellence.‚Äã</p>
      </div>
      <div class="footer-links">
        <h3>Quick Links</h3>
        <a href="index.html">Home</a>
        <a href="index.html#how-it-works">How it Works</a>
        <a href="products.html">Products</a>
        <a href="inspired.html">Get Inspired</a>
        <a href="cart.html">Cart</a>
        <a href="profile.html">Profile</a>
      </div>
      <div class="footer-contact">
        <h3>Contact Us</h3>
        <p>
          Email: 
          <a href="mailto:south-africa@women-in-tech.org">south-africa@women-in-tech.org</a> 
          or 
          <a href="mailto:melissa@women-in-tech.org">melissa@women-in-tech.org</a>
        </p>
        <p>Address: South Africa</p>
      </div>
    </div>
  </footer>

  <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
      // ‚úÖ EmailJS config
        const EMAILJS_PUBLIC_KEY = "EbpMVExnFbfQMt_q-"; 
        const EMAILJS_SERVICE_ID = "service_99b34q9"; 
        const EMAILJS_TEMPLATE_CUSTOMER = "template_05m889k"; // Customer order confirmation
        const EMAILJS_TEMPLATE_ADMIN = "template_mv9r9ox";    // Melissa notification

        emailjs.init("EbpMVExnFbfQMt_q-");

      
        // Format helpers
        function money(n) {
          return Number(n || 0).toFixed(2);
        }

        function buildItemsBlock(items = []) {
          return items.map(it => {
            const qty = it.quantity || 1;
            const size = it.size ? ` (${it.size})` : "";
            const color = it.color ? ` [${it.color}]` : "";
            const line = (Number(it.price || 0) * qty);
            return `‚Ä¢ ${qty} √ó ${it.name || 'Item'}${size}${color} ‚Äî R${money(line)}`;
          }).join("\n");
        }

        function buildShippingBlock(s = {}) {
          const line2 = [s.neighborhood, s.city].filter(Boolean).join(", ");
          return [
            s.name || "",
            s.street || "",
            line2,
            s.postalCode || "",
            s.phone ? `Phone: ${s.phone}` : ""
          ].filter(Boolean).join("\n");
        }

        // ‚úÖ Send both emails
          async function sendOrderEmails({ orderId, shipping, items, total, paymentMethod }) {
            const items_block = buildItemsBlock(items);
            const shipping_block = buildShippingBlock(shipping);

            // Ensure we have a valid customer email
             const to_email_customer = shipping?.email || user?.email;
             const to_name_customer = shipping?.name || user?.displayName || "Customer";
            try {
              // Customer email (goes to buyer)
              if (to_email_customer) {
                await emailjs.send("service_99b34q9", "template_05m889k", {
                  to_email: to_email_customer,
                  to_name: to_name_customer,
                  order_id: orderId,
                  items_block,
                  total: money(total),
                  payment_method: paymentMethod,
                  shipping_block
                });
                console.log("‚úÖ Customer email sent");
              }

              // Admin email (goes to Melissa)
              await emailjs.send("service_99b34q9", "template_mv9r9ox", {
                to_email: "melissa@womenintech.org.za",
                to_name: "Melissa",
                order_id: orderId,
                items_block,
                total: money(total),
                payment_method: paymentMethod,
                shipping_block
              });
              console.log("‚úÖ Admin email sent");

            } catch (err) {
              console.error("‚ùå EmailJS error:", err);
              alert("We couldn‚Äôt send the order emails. Please try again.");
            }
          }


    </script>

    <script>
      async function proceedPayment() {
      const user = auth.currentUser;
      if (!user) {
        alert("Please sign in first!");
        window.location.href = "profile.html";
        return;
      }

      const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
      if (!cartItems.length) {
        alert("Your cart is empty.");
        return;
      }

      // Determine shipping info
      const useProfile = useProfileAddressEl.checked;
      let shipping = {};

      if (useProfile) {
        const snap = await db.collection("users").doc(user.uid).get();
        if (!snap.exists || !snap.data().address) {
          alert("No saved profile address. Please enter manually.");
          return;
        }
        const data = snap.data();
        shipping = {
          name: data.name || user.displayName || "Customer",
          email: data.email || user.email || "",
          phone: data.phone || "",
          ...data.address
        };
      } else {
        shipping = {
          name: document.getElementById("shipName").value.trim() || user.displayName || "Customer",
          email: document.getElementById("shipEmail").value.trim() || user.email || "",
          phone: document.getElementById("shipPhone").value.trim(),
          street: document.getElementById("shipStreet").value.trim(),
          buildingType: document.getElementById("shipBuilding").value.trim(),
          neighborhood: document.getElementById("shipNeighborhood").value.trim(),
          city: document.getElementById("shipCity").value.trim(),
          postalCode: document.getElementById("shipPostal").value.trim(),
        };
      }

      const paymentMethod = document.getElementById("paymentMethod").value;
      if (!paymentMethod) {
        alert("Please select a payment method.");
        return;
      }

      const total = cartItems.reduce((sum, i) => sum + (i.price * i.quantity), 0);

      try {
        // Save order to Firestore
        const docRef = await db.collection("orders").add({
          userId: user.uid,
          items: cartItems,
          total,
          paymentMethod,
          shipping,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Send emails
        await sendOrderEmails({
          orderId: docRef.id,
          shipping,
          items: cartItems,
          total,
          paymentMethod,
          user
        });

        // Handle EFT
        if (paymentMethod === "eft") {
          alert("‚úÖ Order placed! Please EFT the total and send proof of payment. We've emailed you the details.");
          localStorage.removeItem("cart");
          window.location.href = "products.html";
          return;
        }

        // Handle PayFast
        if (paymentMethod === "payfast") {
          const payfastForm = document.createElement("form");
          payfastForm.method = "post";
          payfastForm.action = "https://sandbox.payfast.co.za/eng/process";

          const fields = {
            merchant_id: "10041065",
            merchant_key: "p1aaadaty2wvs",
            return_url: window.location.origin + "/index.html",
            cancel_url: window.location.origin + "/cart.html",
            notify_url: window.location.origin + "/cart.html",
            amount: total.toFixed(2),
            item_name: "Women in Tech Order"
          };

          for (const key in fields) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = fields[key];
            payfastForm.appendChild(input);
          }

          document.body.appendChild(payfastForm);
          payfastForm.submit();
        }

      } catch (err) {
        console.error("‚ùå Error in proceedPayment:", err);
        alert("Something went wrong. Please try again.");
      }
    }


  </script>



  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Config (same project you used on profile page) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCexbP2azBROO_qDR9_W0YBZxN-5FBJp94",
      authDomain: "women-in-tech-f5cdd.firebaseapp.com",
      projectId: "women-in-tech-f5cdd",
      storageBucket: "women-in-tech-f5cdd.firebasestorage.app",
      messagingSenderId: "794639636199",
      appId: "1:794639636199:web:3d898c3fe71d1098d9f442"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- Shipping: use profile or custom form -->
  <script>
    // Toggle between profile address and manual shipping form
    const useProfileAddressEl = document.getElementById("useProfileAddress");
    const shippingFormEl = document.getElementById("shippingForm");
    const profileAddrPreviewEl = document.getElementById("profileAddrPreview");
    const profileAddrMissingEl = document.getElementById("profileAddrMissing");

    useProfileAddressEl.addEventListener("change", () => {
      const useProfile = useProfileAddressEl.checked;
      shippingFormEl.style.display = useProfile ? "none" : "block";
    });

    // Load profile address like cart items (compat mode)
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        profileAddrPreviewEl.innerHTML = `<span class="addr-empty">Please sign in to use your profile address.</span>`;
        return;
      }

      try {
        const userSnap = await db.collection("users").doc(user.uid).get();

        if (!userSnap.exists) {
          profileAddrPreviewEl.classList.add("hidden");
          profileAddrMissingEl.classList.remove("hidden");
          return;
        }

        const data = userSnap.data();
        const address = data.address || {};
        const lines = [
          data.name || user.email,
          address.street || "",
          [address.neighborhood, address.city].filter(Boolean).join(", "),
          address.postalCode || ""
        ].filter(Boolean);

        if (lines.length) {
          profileAddrPreviewEl.innerHTML = `<p>${lines.join("<br>")}</p>`;
          profileAddrPreviewEl.classList.remove("hidden");
          profileAddrMissingEl.classList.add("hidden");
        } else {
          profileAddrPreviewEl.classList.add("hidden");
          profileAddrMissingEl.classList.remove("hidden");
        }

      } catch (err) {
        console.error("Error fetching address:", err);
        profileAddrPreviewEl.innerHTML = `<span class="addr-empty">Could not load profile address. You can manually enter shipping details below.</span>`;
      }
    });



  </script>

  <script>
      function loadCheckoutTotal() {
        // Load cart from localStorage
        const cartItems = JSON.parse(localStorage.getItem("cart")) || [];

        // Calculate total
        const total = cartItems.reduce((sum, item) => {
          const price = parseFloat(item.price) || 0;
          const qty = item.quantity || 1;
          return sum + price * qty;
        }, 0);

        // Update checkout page
        document.getElementById("orderTotal").innerText = total.toFixed(2);

        return total; // so we can reuse it later
      }

      // Run this when checkout page loads
      const orderTotal = loadCheckoutTotal();

      function showPaymentDetails() {
        const method = document.getElementById("paymentMethod").value;
        document.querySelectorAll(".payment-box").forEach(box => box.style.display = "none");
        if (method) {
          document.getElementById(method).style.display = "block";
        }
      }

      /*
      function proceedPayment() {
        const method = document.getElementById("paymentMethod").value;
        if (!method) {
          alert("Please select a payment method.");
          return;
        }

        if (method === "eft") {
          alert("Order placed! Please EFT the total and send proof of payment.");
          // Show confirmation message here instead of redirect if you want
        }

        if (method === "payfast") {
          const payfastForm = document.createElement("form");
          payfastForm.method = "post";
          payfastForm.action = "https://sandbox.payfast.co.za/eng/process";

          const fields = {
            merchant_id: "10041065",
            merchant_key: "p1aaadaty2wvs",
            return_url: window.location.origin + "/index.html",
            cancel_url: window.location.origin + "/cart.html",
            notify_url: window.location.origin + "/https://cc787e5b907a.ngrok-free.app",
            amount: orderTotal.toFixed(2), // ‚úÖ now uses calculated total
            item_name: "Women in Tech Order"
          };

          for (const key in fields) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = fields[key];
            payfastForm.appendChild(input);
          }

          document.body.appendChild(payfastForm);
          payfastForm.submit();
        }
      }
        */
    </script>


  <script>
    let speech;
    let isSpeaking = false;
    let isPaused = false;

    function readAllText() {
      const btn = document.getElementById("speechBtn");

      // Case 1: Already speaking and not paused ‚Üí Pause
      if (isSpeaking && !isPaused) {
        window.speechSynthesis.pause();
        isPaused = true;
        btn.textContent = "‚ñ∂ Resume";
        return;
      }

      // Case 2: Paused ‚Üí Resume
      if (isSpeaking && isPaused) {
        window.speechSynthesis.resume();
        isPaused = false;
        btn.textContent = "‚è∏ Pause";
        return;
      }

      // Case 3: Not speaking ‚Üí Start new speech
      const allText = document.body.innerText;
      speech = new SpeechSynthesisUtterance(allText);
      speech.lang = "en-ZA"; // South African English

      speech.onend = () => {
        isSpeaking = false;
        isPaused = false;
        btn.textContent = "üîä Read"; // Reset when finished
      };

      window.speechSynthesis.cancel(); // stop any queued speech
      window.speechSynthesis.speak(speech);

      isSpeaking = true;
      isPaused = false;
      btn.textContent = "‚è∏ Pause";
    }
  </script>

</body>
</html>
